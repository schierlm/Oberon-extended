# Importing any number of modules
FPGA Oberon (see http://www.projectoberon.com) has a restriction that only 15 modules can be imported. Usually, this poses no problem, as it is good programming practice to define the module hierarchy such that only a small number of modules is (directly) imported by any given module.

However, this upper limit also includes modules from which types are referenced *indirectly*. Such modules do not necessarily appear in the import list of a module, i.e. their imports may be *hidden*. In deep module hierarchies, lifting this restricton may therefore become desirable.

Extended Oberon increases the maximum number of modules that can be imported (directly or indirectly) to 63.

This is achieved by adjusting all instructions and data elements concerned to use 6 bits instead of 4 bits for the module number (mno) and by adapting their associated fixup mechanisms in the module loader accordingly.

**1. BL instructions for external procedure calls**

Change BL instructions for external procedure calls, as generated by the compiler (see *ORG.Call*) from

     | BL (4) | cond (4) | mno (4) | pno (8) | pc-fixorgP (12) |    (max mno = 15, max pno = 255, max disp = 2^12-1 = 4K-1 words)

to

     | BL (4) | mno (6) | pno (8) | pc-fixorgP (14) |    (max mno = 63, max pno = 255, max disp = 2^14-1 = 16K-1 words)

which the module loader will fix up to

     | BL (4) | cond (4) | offset relative to PC (24) |    (max offset = 2^24-1 = 16M-1 words)

Thus, the *cond* field is eliminated from the instruction, as generated by the compiler, and re-inserted by the loader.

This is possible because BL instructions only ever use *cond* = 7 (=always) and the module loader already inserts *BL 7* as a hardcoded constant in the fixed up instruction anyway (see the fixup code at the end of procedure *Modules.Load*).

The new (compile-time) instruction encoding also increases the maximum displacement between two BL instructions in the fixup chain from 2^12-1 = 4K-1 words to 2^14-1 = 16K-1 words. Given that the array *ORG.code* holds only 8K words, this eliminates the need for an extra check in *ORG.Call* whether a fixup is possible (*IF pc-fixorgP < 1000H*).

We keep the first 4 bits of the BL instruction so that *ORTool.DecObj* can recognize it as such. An alternative would have been to keep only the first 2 bits, leaving 8 bits for the module number (mno). But we opted to keep the U and V bits as well, as they are interpreted by *ORTool.DecObj*. Using 6 bits for the module number is no real limitation, as 2^6-1 = 63 imported modules should be enough for most purposes, even when taking into account indirectly imported modules.

**2. LD instructions for loading the static base of a module**

Change LD instructions for loading the static base of a module, as generated by the compiler (see *ORG.GetSB*) from

     | LD (4) | reg (4) | mno (4) | pc-fixorgD (20) |    (max mno = 15, max disp = 2^20-1 = 1M-1 words)

to

     | LD (4) | reg (4) | mno (6) | pc-fixorgD (18) |    (max mno = 63, max disp = 2^18-1 = 256K-1 words)

which the module loader will fix up to

     | LD (4) | reg (4) | MT (4) | offset for imported module in MT table (20) |    (max offset = 2^20-1 = 1M-1 words)

**3. Entries in type descriptor extension tables**

Change entries in type descriptor extension tables, as generated by the compiler (see *ORG.Q*) from

     | unused (4) | mno (4) | TDadr/exno (12) | pc-fixorgT (12) |    (max mno = 15, max TDadr/exno = 4095, max disp = 2^12-1 = 4K-1 words)

to

     | unused (2) | mno (6) | TDadr/exno (12) | pc-fixorgT (12) |    (max mno = 63, max TDadr/exno = 4095, max disp = 2^12-1 = 4K-1 words)

which the module loader will fix up to

     | absolute memory address of type descriptor (32) |

Extension table entries generated by the compiler already allowed 8 bits for the module number (mno), but the module loader previously extracted only the least significant 4 bits during the fixup phase. It now extracts 6 bits.

**4. Entries in method tables (Extended Oberon only)**

Change entries in method tables, as generated by the compiler (see *ORG.BuildTD*) from

     | unused (4) | mno (4) | mthadr/exno (14) | pc-fixorgM (10) |    (max mno = 15, max disp = 2^10-1 = 1023 words)

to

     | unused (2) | mno (6) | mthadr/exno (14) | pc-fixorgM (10) |    (max mno = 63, max disp = 2^10-1 = 1023 words)

which the module loader will fix up to

     | absolute memory address of method (32) |

Method table entries generated by the compiler already allowed 8 bits for the module number (mno), but the module loader previously extracted only the least significant 4 bits during the fixup phase. It now extracts 6 bits.

**5. BL instructions for external super calls (Extended Oberon only)**

Change BL instructions for external super calls, as generated by the compiler (see *ORG.Call*) from

     | BL (4) | cond (4) | mno (4) | pno (8) | pc-fixorgP (12) |    (max mno = 15, max pno = 255, max disp = 2^12-1 = 4K-1 words)

to

     | BL (4) | mno (6) | pno (8) | pc-fixorgP (14) |    (max mno = 63, max pno = 255, max disp = 2^14-1 = 16K-1 words)

which the module loader will fix up to

     | BL (4) | cond (4) | offset relative to PC (24) |    (max offset = 2^24-1 = 16M-1 words)
